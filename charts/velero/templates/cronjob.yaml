kind: CronJob
apiVersion: batch/v1
metadata:
  name: velero-backup-job
  namespace: infra-backup-projects
spec:
  schedule: "{{ .Values.schedule_cron }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 5
  jobTemplate:
    metadata:
      labels:
        app: projects-backup
    spec:
      backoffLimit: 0
      template:
        metadata:
          labels:
            app: projects-backup
        spec:
          containers:
          - name: backup
            image: registry.redhat.io/openshift4/ose-cli:v4.11
            securityContext:
              privileged: true
            command: ["/bin/sh", "-c"]
            args: ["echo 'IC9kZXYvbnVsbDsgdGhlbgogICAgZWNobyAiTGUgc2NoZWR1bGUgJHtzY2hlZHVsZU5hbWV9IGV4aXN0ZSBkw6lqw6AsIGlsIG5lIHNlcmEgcGFzIHN1cHByaW3DqS4iCiAgICBrdWJlY3RsIGRlbGV0ZSBzY2hlZHVsZSAke3NjaGVkdWxlTmFtZX0gLW4gb3BlbnNoaWZ0LWFkcAogIGVsc2UKICAgIGVjaG8gIkxlIHNjaGVkdWxlICR7c2NoZWR1bGVOYW1lfSBuJ2V4aXN0ZSBwYXMiCiAgZmkKZG9uZQoKIyBJbml0aWFsaXNhdGlvbiBkZXMgdmFyaWFibGVzIG1pbnV0ZSBldCBoZXVyZQptaW51dGU9MApoZXVyZT0wCgprdWJlY3RsIGdldCAgbnMgLS1zZWxlY3Rvcj1zYXZlZC1ieS12ZWxlcm89dHJ1ZSAtbyBjdXN0b20tY29sdW1ucz0iTkFNRToubWV0YWRhdGEubmFtZSIgfHRhaWwgLW4gKzIgfHdoaWxlIHJlYWQgbmFtZVNwYWNlIDtkbwogIGV4cG9ydCBzY2hlZHVsZU5hbWU9JHtuYW1lU3BhY2V9CiAgZXhwb3J0IG5hbWVTcGFjZQoKICAjIFbDqXJpZmljYXRpb24gc2kgbGUgc2NoZWR1bGUgZXhpc3RlIGTDqWrDoAogIGlmIGt1YmVjdGwgZ2V0IHNjaGVkdWxlICR7c2NoZWR1bGVOYW1lfSAtbiAke3ZlbGVyb05hbWVTcGFjZX0gJj4gL2Rldi9udWxsOyB0aGVuCiAgICBlY2hvICJMZSBzY2hlZHVsZSAke3NjaGVkdWxlTmFtZX0gZXhpc3RlIGTDqWrDoC4iCiAgZWxzZQoKICAgICMgSW5jcsOpbWVudGF0aW9uIGRlIGxhIHZhcmlhYmxlIG1pbnV0ZQogICAgbWludXRlPSQoKG1pbnV0ZSArIDUpKQoKICAgICMgSW5jcsOpbWVudGF0aW9uIGRlIGxhIHZhcmlhYmxlIGhldXJlIHNpIG1pbnV0ZSBhdHRlaW50IG91IGTDqXBhc3NlIDYwCiAgICBpZiBbICRtaW51dGUgLWdlIDYwIF07IHRoZW4KICAgICAgbWludXRlPTAKICAgICAgaGV1cmU9JCgoaGV1cmUgKyAxKSkKICAgIGZpCgogICAgIyBSw6lpbml0aWFsaXNhdGlvbiBkZSBsYSB2YXJpYWJsZSBoZXVyZSBzaSBlbGxlIGF0dGVpbnQgb3UgZMOpcGFzc2UgMjQKICAgIGlmIFsgJGhldXJlIC1nZSAyNCBdOyB0aGVuCiAgICAgIGhldXJlPTAKICAgIGZpCgogICAgY2F0IDw8RU9GIHwga3ViZWN0bCAtbiAke3ZlbGVyb05hbWVTcGFjZX0gYXBwbHkgLWYgLQphcGlWZXJzaW9uOiB2ZWxlcm8uaW8vdjEKa2luZDogU2NoZWR1bGUKbWV0YWRhdGE6CiAgbmFtZTogJHtzY2hlZHVsZU5hbWV9CiAgbmFtZXNwYWNlOiAke3ZlbGVyb05hbWVTcGFjZX0Kc3BlYzoKICBzY2hlZHVsZTogJyR7bWludXRlfSAke2hldXJlfSAqICogKicKICB0ZW1wbGF0ZToKICAgIHN0b3JhZ2VMb2NhdGlvbjogJHtzdG9yYWdlTG9jYXRpb259CiAgICB0dGw6IDI0MGgwbTBzCiAgICBkZWZhdWx0Vm9sdW1lc1RvUmVzdGljOiB0cnVlCiAgICBpbmNsdWRlZE5hbWVzcGFjZXM6CiAgICAgIC0gJHtuYW1lU3BhY2V9CkVPRgogIGZpCmRvbmUK' | base64 -d | bash"]
          restartPolicy: Never
          terminationGracePeriodSeconds: 30
          activeDeadlineSeconds: 600
          dnsPolicy: "ClusterFirst"
          serviceAccount: "projects-backup"
          serviceAccountName: projects-backup
