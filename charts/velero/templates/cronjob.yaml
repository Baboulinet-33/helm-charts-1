kind: CronJob
apiVersion: batch/v1
metadata:
  name: velero-backup-job
  namespace: infra-backup-projects
spec:
  schedule: "{{ .Values.schedule_cron }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 5
  jobTemplate:
    metadata:
      labels:
        app: projects-backup
    spec:
      backoffLimit: 0
      template:
        metadata:
          labels:
            app: projects-backup
        spec:
          containers:
          - name: backup
            image: registry.redhat.io/openshift4/ose-cli:v4.11
            securityContext:
              privileged: true
            command: ["/bin/sh", "-c"]
            args: ["echo 'L2Rldi9udWxsOyB0aGVuCiAgICBlY2hvICJMZSBzY2hlZHVsZSAke3NjaGVkdWxlTmFtZX0gZXhpc3RlIGTDqWrDoCwgaWwgbmUgc2VyYSBwYXMgc3VwcHJpbcOpLiIKICAgIGt1YmVjdGwgZGVsZXRlIHNjaGVkdWxlICR7c2NoZWR1bGVOYW1lfSAtbiBvcGVuc2hpZnQtYWRwCiAgZWxzZQogICAgZWNobyAiTGUgc2NoZWR1bGUgJHtzY2hlZHVsZU5hbWV9IG4nZXhpc3RlIHBhcyIKICBmaQpkb25lCgojIEluaXRpYWxpc2F0aW9uIGRlcyB2YXJpYWJsZXMgbWludXRlIGV0IGhldXJlCm1pbnV0ZT0wCmhldXJlPTAKCmt1YmVjdGwgZ2V0ICBucyAtLXNlbGVjdG9yPXNhdmVkLWJ5LXZlbGVybz10cnVlIC1vIGN1c3RvbS1jb2x1bW5zPSJOQU1FOi5tZXRhZGF0YS5uYW1lIiB8dGFpbCAtbiArMiB8d2hpbGUgcmVhZCBuYW1lU3BhY2UgO2RvCiAgZXhwb3J0IHNjaGVkdWxlTmFtZT0ke25hbWVTcGFjZX0KICBleHBvcnQgbmFtZVNwYWNlCgogICMgVsOpcmlmaWNhdGlvbiBzaSBsZSBzY2hlZHVsZSBleGlzdGUgZMOpasOgCiAgaWYga3ViZWN0bCBnZXQgc2NoZWR1bGUgJHtzY2hlZHVsZU5hbWV9IC1uICR7dmVsZXJvTmFtZVNwYWNlfSAmPiAvZGV2L251bGw7IHRoZW4KICAgIGVjaG8gIkxlIHNjaGVkdWxlICR7c2NoZWR1bGVOYW1lfSBleGlzdGUgZMOpasOgLiIKICBlbHNlCgogICAgIyBJbmNyw6ltZW50YXRpb24gZGUgbGEgdmFyaWFibGUgbWludXRlCiAgICBtaW51dGU9JCgobWludXRlICsgNSkpCgogICAgIyBJbmNyw6ltZW50YXRpb24gZGUgbGEgdmFyaWFibGUgaGV1cmUgc2kgbWludXRlIGF0dGVpbnQgb3UgZMOpcGFzc2UgNjAKICAgIGlmIFsgJG1pbnV0ZSAtZ2UgNjAgXTsgdGhlbgogICAgICBtaW51dGU9MAogICAgICBoZXVyZT0kKChoZXVyZSArIDEpKQogICAgZmkKCiAgICAjIFLDqWluaXRpYWxpc2F0aW9uIGRlIGxhIHZhcmlhYmxlIGhldXJlIHNpIGVsbGUgYXR0ZWludCBvdSBkw6lwYXNzZSAyNAogICAgaWYgWyAkaGV1cmUgLWdlIDI0IF07IHRoZW4KICAgICAgaGV1cmU9MAogICAgZmkKCiAgICBjYXQgPDxFT0YgfCBrdWJlY3RsIC1uICR7dmVsZXJvTmFtZVNwYWNlfSBhcHBseSAtZiAtCmFwaVZlcnNpb246IHZlbGVyby5pby92MQpraW5kOiBTY2hlZHVsZQptZXRhZGF0YToKICBuYW1lOiAke3NjaGVkdWxlTmFtZX0KICBuYW1lc3BhY2U6ICR7dmVsZXJvTmFtZVNwYWNlfQpzcGVjOgogIHNjaGVkdWxlOiAnJHttaW51dGV9ICR7aGV1cmV9ICogKiAqJwogIHRlbXBsYXRlOgogICAgc3RvcmFnZUxvY2F0aW9uOiAke3N0b3JhZ2VMb2NhdGlvbn0KICAgIHR0bDogMjQwaDBtMHMKICAgIGRlZmF1bHRWb2x1bWVzVG9SZXN0aWM6IHRydWUKICAgIGluY2x1ZGVkTmFtZXNwYWNlczoKICAgICAgLSAke25hbWVTcGFjZX0KRU9GCiAgZmkKZG9uZQo=' | base64 -d | bash"]
          restartPolicy: Never
          terminationGracePeriodSeconds: 30
          activeDeadlineSeconds: 600
          dnsPolicy: "ClusterFirst"
          serviceAccount: "projects-backup"
          serviceAccountName: projects-backup
