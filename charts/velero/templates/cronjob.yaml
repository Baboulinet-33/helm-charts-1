kind: CronJob
apiVersion: batch/v1
metadata:
  name: velero-backup-job
  namespace: "{{ .Values.namespace_adp }}"
spec:
  schedule: "{{ .Values.schedule_cron }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 5
  jobTemplate:
    metadata:
      labels:
        app: projects-backup
    spec:
      backoffLimit: 0
      template:
        metadata:
          labels:
            app: projects-backup
        spec:
          containers:
          - name: backup
            image: registry.redhat.io/openshift4/ose-cli:v4.11
            securityContext:
              privileged: true
            command: ["/bin/sh", "-c"]
            args: ["echo 'ZXhwb3J0IHZlbGVyb05hbWVTcGFjZT1vcGVuc2hpZnQtYWRwCmV4cG9ydCBzdG9yYWdlTG9jYXRpb249dmVsZXJvLTEKCmt1YmVjdGwgZ2V0IG5zIC0tc2VsZWN0b3I9c2F2ZS1ieS12ZWxlcm8hPXRydWUgLW8gY3VzdG9tLWNvbHVtbnM9Ik5BTUU6Lm1ldGFkYXRhLm5hbWUifHdoaWxlIHJlYWQgbmFtZVNwYWNlIDtkbwogIGV4cG9ydCBzY2hlZHVsZU5hbWU9JHtuYW1lU3BhY2V9CiAgZXhwb3J0IG5hbWVTcGFjZQogIGt1YmVjdGwgZGVsZXRlIHNjaGVkdWxlICR7c2NoZWR1bGVOYW1lfSAtbiBvcGVuc2hpZnQtYWRwCmRvbmUKCgppZiBrdWJlY3RsIGdldCBzY2hlZHVsZSBjbHVzdGVyLXJlc291cmNlcyAtbiAke3ZlbGVyb05hbWVTcGFjZX0gJj4gL2Rldi9udWxsOyB0aGVuCiAgZWNobyAiTGUgc2NoZWR1bGUgJ2NsdXN0ZXItcmVzb3VyY2VzJyBleGlzdGUuIgplbHNlCiAgY2F0IDw8RU9GIHxrdWJlY3RsIC1uICR7dmVsZXJvTmFtZVNwYWNlfSBhcHBseSAtZiAtCmFwaVZlcnNpb246IHZlbGVyby5pby92MQpraW5kOiBTY2hlZHVsZQptZXRhZGF0YToKICBuYW1lOiBjbHVzdGVyLXJlc291cmNlcwogIG5hbWVzcGFjZTogJHt2ZWxlcm9OYW1lU3BhY2V9CnNwZWM6CiAgc2NoZWR1bGU6ICcwIDAgKiAqICogJwogIHRlbXBsYXRlOgogICAgZGVmYXVsdFZvbHVtZXNUb1Jlc3RpYzogdHJ1ZQogICAgaW5jbHVkZUNsdXN0ZXJSZXNvdXJjZXM6IHRydWUKICAgIHN0b3JhZ2VMb2NhdGlvbjogJHtzdG9yYWdlTG9jYXRpb259CiAgICB0dGw6IDI0MGgwbTBzCkVPRgpmaQoKIyBJbml0aWFsaXNhdGlvbiBkZXMgdmFyaWFibGVzIG1pbnV0ZSBldCBoZXVyZQptaW51dGU9MApoZXVyZT0wCgprdWJlY3RsIGdldCBuYW1lc3BhY2VzIC0tc2VsZWN0b3I9c2F2ZWQtYnktdmVsZXJvPXRydWUgLW8gY3VzdG9tLWNvbHVtbnM9Ik5BTUU6Lm1ldGFkYXRhLm5hbWUiIHx0YWlsIC1uICsyIHx3aGlsZSByZWFkIG5hbWVTcGFjZSA7ZG8KICBleHBvcnQgc2NoZWR1bGVOYW1lPSR7bmFtZVNwYWNlfQogIGV4cG9ydCBuYW1lU3BhY2UKICAgICMgSW5jcsOpbWVudGF0aW9uIGRlIGxhIHZhcmlhYmxlIG1pbnV0ZQogIG1pbnV0ZT0kKChtaW51dGUgKyA1KSkKCiAgIyBJbmNyw6ltZW50YXRpb24gZGUgbGEgdmFyaWFibGUgaGV1cmUgc2kgbWludXRlIGF0dGVpbnQgb3UgZMOpcGFzc2UgNjAKICBpZiBbICRtaW51dGUgLWdlIDYwIF07IHRoZW4KICAgIG1pbnV0ZT0wCiAgICBoZXVyZT0kKChoZXVyZSArIDEpKQogIGZpCgogICMgUsOpaW5pdGlhbGlzYXRpb24gZGUgbGEgdmFyaWFibGUgaGV1cmUgc2kgZWxsZSBhdHRlaW50IG91IGTDqXBhc3NlIDI0CiAgaWYgWyAkaGV1cmUgLWdlIDI0IF07IHRoZW4KICAgIGhldXJlPTAKICBmaQoKICBjYXQgPDxFT0YgfGt1YmVjdGwgLW4gJHt2ZWxlcm9OYW1lU3BhY2V9IGFwcGx5IC1mIC0KYXBpVmVyc2lvbjogdmVsZXJvLmlvL3YxCmtpbmQ6IFNjaGVkdWxlCm1ldGFkYXRhOgogIG5hbWU6ICR7c2NoZWR1bGVOYW1lfQogIG5hbWVzcGFjZTogJHt2ZWxlcm9OYW1lU3BhY2V9CnNwZWM6CiAgc2NoZWR1bGU6ICcke21pbnV0ZX0gJHtoZXVyZX0gKiAqIConCiAgdGVtcGxhdGU6CiAgICBzdG9yYWdlTG9jYXRpb246ICR7c3RvcmFnZUxvY2F0aW9ufQogICAgdHRsOiAyNDBoMG0wcwogICAgZGVmYXVsdFZvbHVtZXNUb1Jlc3RpYzogdHJ1ZQogICAgaW5jbHVkZWROYW1lc3BhY2VzOgogICAgICAtICR7bmFtZVNwYWNlfQpFT0YKZG9uZQo=' | base64 -d | bash"]
          restartPolicy: Never
          terminationGracePeriodSeconds: 30
          activeDeadlineSeconds: 600
          dnsPolicy: "ClusterFirst"
          serviceAccount: "projects-backup"
          serviceAccountName: projects-backup
