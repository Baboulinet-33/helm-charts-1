---
kind: CronJob
apiVersion: batch/v1
metadata:
  name: velero-backup-job
  namespace: infra-backup-projects
spec:
  schedule: "{{ .Values.schedule_cron }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 5
  jobTemplate:
    metadata:
      labels:
        app: projects-backup
    spec:
      backoffLimit: 0
      template:
        metadata:
          labels:
            app: projects-backup
        spec:
          containers:
          - name: backup
            image: registry.redhat.io/openshift4/ose-cli:v4.11
            securityContext:
              privileged: true
            command: ["/bin/sh", "-c"]
            args: ["echo 'ZXhwb3J0IHZlbGVyb05hbWVTcGFjZT1vcGVuc2hpZnQtYWRwCmV4cG9ydCBzdG9yYWdlTG9jYXRpb249dmVsZXJvLTEKCmlmIGt1YmVjdGwgZ2V0IHNjaGVkdWxlIGNsdXN0ZXItcmVzb3VyY2VzIC1uICR7dmVsZXJvTmFtZVNwYWNlfSAmPiAvZGV2L251bGw7IHRoZW4KICBlY2hvICJMZSBzY2hlZHVsZSAnY2x1c3Rlci1yZXNvdXJjZXMnIGV4aXN0ZS4iCmVsc2UKICBjYXQgPDxFT0YgfGt1YmVjdGwgLW4gJHt2ZWxlcm9OYW1lU3BhY2V9IGFwcGx5IC1mIC0KYXBpVmVyc2lvbjogdmVsZXJvLmlvL3YxCmtpbmQ6IFNjaGVkdWxlCm1ldGFkYXRhOgogIG5hbWU6IGNsdXN0ZXItcmVzb3VyY2VzCiAgbmFtZXNwYWNlOiAke3ZlbGVyb05hbWVTcGFjZX0Kc3BlYzoKICBzY2hlZHVsZTogJzAgMCAqICogKiAnCiAgdGVtcGxhdGU6CiAgICBkZWZhdWx0Vm9sdW1lc1RvUmVzdGljOiB0cnVlCiAgICBpbmNsdWRlQ2x1c3RlclJlc291cmNlczogdHJ1ZQogICAgc3RvcmFnZUxvY2F0aW9uOiAke3N0b3JhZ2VMb2NhdGlvbn0KICAgIHR0bDogMjQwaDBtMHMKICAgIGluY2x1ZGVkTmFtZXNwYWNlczoKICAgICAgLSBkZWZhdWx0CkVPRgpmaQoKIyBMaXN0ZXIgbGVzIHNjaGVkdWxlcyBleGlzdGFudHMKZXhpc3Rpbmdfc2NoZWR1bGVzPSQoa3ViZWN0bCBnZXQgc2NoZWR1bGVzIC1uICR7dmVsZXJvTmFtZVNwYWNlfSAgLW8ganNvbnBhdGg9J3suaXRlbXNbKl0ubWV0YWRhdGEubmFtZX0nKQoKIyBCb3VjbGVyIMOgIHRyYXZlcnMgbGEgbGlzdGUgZGVzIHNjaGVkdWxlcyBleGlzdGFudHMKZm9yIHNjaGVkdWxlIGluICRleGlzdGluZ19zY2hlZHVsZXM7IGRvCiAgICAjIElnbm9yZXIgbGUgc2NoZWR1bGUgJ2NsdXN0ZXItcmVzc291cmNlcycKICAgIGlmIFtbICRzY2hlZHVsZSA9PSAiY2x1c3Rlci1yZXNvdXJjZXMiIHx8ICRzY2hlZHVsZSA9PSAiZHNvLWJhY2t1cCIgXV07IHRoZW4KICAgICAgICBlY2hvICJJZ25vcmVyIGxlIHNjaGVkdWxlIDogJHNjaGVkdWxlIgogICAgICAgIGNvbnRpbnVlCiAgICBmaQoKICAgICMgVsOpcmlmaWVyIHNpIGxlIG5hbWVzcGFjZSBjb3JyZXNwb25kYW50IGV4aXN0ZQogICAgbmFtZXNwYWNlX2V4aXN0cz0kKGt1YmVjdGwgZ2V0IG5zICRzY2hlZHVsZSAtLWlnbm9yZS1ub3QtZm91bmQgLW8ganNvbnBhdGg9J3subWV0YWRhdGEubmFtZX0nKQoKICAgIGlmIFtbIC16ICRuYW1lc3BhY2VfZXhpc3RzIF1dOyB0aGVuCiAgICAgICAgIyBMZSBuYW1lc3BhY2UgbidleGlzdGUgcGx1cywgc3VwcHJpbWVyIGxlIHNjaGVkdWxlCiAgICAgICAgZWNobyAiU3VwcHJlc3Npb24gZHUgc2NoZWR1bGUgOiAkc2NoZWR1bGUiCiAgICAgICAga3ViZWN0bCBkZWxldGUgc2NoZWR1bGUgJHNjaGVkdWxlIC1uICR7dmVsZXJvTmFtZVNwYWNlfQogICAgZWxzZQogICAgICAgIGVjaG8gIkxlIG5hbWVzcGFjZSAkc2NoZWR1bGUgZXhpc3RlIGVuY29yZSIKICAgIGZpCmRvbmUKCmt1YmVjdGwgZ2V0IG5zIC0tc2VsZWN0b3I9c2F2ZWQtYnktdmVsZXJvIT10cnVlIC1vIGN1c3RvbS1jb2x1bW5zPSJOQU1FOi5tZXRhZGF0YS5uYW1lInx3aGlsZSByZWFkIG5hbWVTcGFjZSA7ZG8KICBleHBvcnQgc2NoZWR1bGVOYW1lPSR7bmFtZVNwYWNlfQogIGV4cG9ydCBuYW1lU3BhY2UKICAgICMgVsOpcmlmaWVyIHNpIGxlIHNjaGVkdWxlIGV4aXN0ZSBkw6lqw6AKICBpZiBrdWJlY3RsIGdldCBzY2hlZHVsZSAke3NjaGVkdWxlTmFtZX0gLW4gJHt2ZWxlcm9OYW1lU3BhY2V9ICY+L2Rldi9udWxsOyB0aGVuCiAgICBlY2hvICJMZSBzY2hlZHVsZSAke3NjaGVkdWxlTmFtZX0gZXhpc3RlIGTDqWrDoCwgaWwgc2VyYSBzdXBwcmltw6kuIgogICAga3ViZWN0bCBkZWxldGUgc2NoZWR1bGUgJHtzY2hlZHVsZU5hbWV9IC1uICR7dmVsZXJvTmFtZVNwYWNlfSAKICBlbHNlCiAgICBlY2hvICJMZSBzY2hlZHVsZSAke3NjaGVkdWxlTmFtZX0gbidleGlzdGUgcGFzIgogIGZpCmRvbmUKCiMgSW5pdGlhbGlzYXRpb24gZGVzIHZhcmlhYmxlcyBtaW51dGUgZXQgaGV1cmUKbWludXRlPTAKaGV1cmU9MAoKa3ViZWN0bCBnZXQgIG5zIC0tc2VsZWN0b3I9c2F2ZWQtYnktdmVsZXJvPXRydWUgLW8gY3VzdG9tLWNvbHVtbnM9Ik5BTUU6Lm1ldGFkYXRhLm5hbWUiIHx0YWlsIC1uICsyIHx3aGlsZSByZWFkIG5hbWVTcGFjZSA7ZG8KICBleHBvcnQgc2NoZWR1bGVOYW1lPSR7bmFtZVNwYWNlfQogIGV4cG9ydCBuYW1lU3BhY2UKCiAgIyBWw6lyaWZpY2F0aW9uIHNpIGxlIHNjaGVkdWxlIGV4aXN0ZSBkw6lqw6AKICBpZiBrdWJlY3RsIGdldCBzY2hlZHVsZSAke3NjaGVkdWxlTmFtZX0gLW4gJHt2ZWxlcm9OYW1lU3BhY2V9ICY+IC9kZXYvbnVsbDsgdGhlbgogICAgZWNobyAiTGUgc2NoZWR1bGUgJHtzY2hlZHVsZU5hbWV9IGV4aXN0ZSBkw6lqw6AuIgogIGVsc2UKCiAgICAjIEluY3LDqW1lbnRhdGlvbiBkZSBsYSB2YXJpYWJsZSBtaW51dGUKICAgIG1pbnV0ZT0kKChtaW51dGUgKyA1KSkKCiAgICAjIEluY3LDqW1lbnRhdGlvbiBkZSBsYSB2YXJpYWJsZSBoZXVyZSBzaSBtaW51dGUgYXR0ZWludCBvdSBkw6lwYXNzZSA2MAogICAgaWYgWyAkbWludXRlIC1nZSA2MCBdOyB0aGVuCiAgICAgIG1pbnV0ZT0wCiAgICAgIGhldXJlPSQoKGhldXJlICsgMSkpCiAgICBmaQoKICAgICMgUsOpaW5pdGlhbGlzYXRpb24gZGUgbGEgdmFyaWFibGUgaGV1cmUgc2kgZWxsZSBhdHRlaW50IG91IGTDqXBhc3NlIDI0CiAgICBpZiBbICRoZXVyZSAtZ2UgMjQgXTsgdGhlbgogICAgICBoZXVyZT0wCiAgICBmaQoKICAgIGNhdCA8PEVPRiB8IGt1YmVjdGwgLW4gJHt2ZWxlcm9OYW1lU3BhY2V9IGFwcGx5IC1mIC0KYXBpVmVyc2lvbjogdmVsZXJvLmlvL3YxCmtpbmQ6IFNjaGVkdWxlCm1ldGFkYXRhOgogIG5hbWU6ICR7c2NoZWR1bGVOYW1lfQogIG5hbWVzcGFjZTogJHt2ZWxlcm9OYW1lU3BhY2V9CnNwZWM6CiAgc2NoZWR1bGU6ICcke21pbnV0ZX0gJHtoZXVyZX0gKiAqIConCiAgdGVtcGxhdGU6CiAgICBzdG9yYWdlTG9jYXRpb246ICR7c3RvcmFnZUxvY2F0aW9ufQogICAgdHRsOiAyNDBoMG0wcwogICAgZGVmYXVsdFZvbHVtZXNUb1Jlc3RpYzogdHJ1ZQogICAgaW5jbHVkZWROYW1lc3BhY2VzOgogICAgICAtICR7bmFtZVNwYWNlfQpFT0YKICBmaQpkb25lCg==' | base64 -d | bash"]
          restartPolicy: Never
          terminationGracePeriodSeconds: 30
          activeDeadlineSeconds: 600
          dnsPolicy: "ClusterFirst"
          serviceAccount: "projects-backup"
          serviceAccountName: projects-backup
